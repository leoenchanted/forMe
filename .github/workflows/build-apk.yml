name: Build Android APK & Release
permissions:
  contents: write
on:
  workflow_dispatch:

jobs:
  build:
    name: ğŸ— Build & Release
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¦ Check out Git repository
        uses: actions/checkout@v4

      # ğŸ”¥ æ ¸å¿ƒï¼šå¢åŠ  Swap ç©ºé—´ï¼Œé˜²æ­¢ OOM çˆ†å†…å­˜ (ä¿ç•™ä½ çš„ä¼˜åŒ–)
      - name: ğŸ’¾ Increase Swap Space
        run: |
          sudo swapoff -a
          sudo fallocate -l 10G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          sudo swapon --show

      # è¯»å– app.config.js é‡Œçš„ç‰ˆæœ¬å· (è®°å¾—æœ¬åœ°è¦æŠŠ version æ”¹æˆ 1.1.5)
      - name: ğŸ“– Get Version
        id: get_version
        run: |
          echo "APP_VERSION=$(jq -r .expo.version app.config.js || jq -r .expo.version app.json)" >> $GITHUB_OUTPUT

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18.x
          cache: npm

      - name: âš™ï¸ Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: ğŸ“¦ Install dependencies
        run: npm install

      # ä½¿ç”¨ --clear-cache ç¡®ä¿å¹²å‡€æ„å»º
      - name: ğŸš€ Build APK (Local)
        run: eas build --platform android --profile preview --non-interactive --local --clear-cache --output=./forme.apk

      - name: ğŸ‰ Create Release
        uses: ncipollo/release-action@v1
        with:
          tag: "v${{ steps.get_version.outputs.APP_VERSION }}"
          name: "v${{ steps.get_version.outputs.APP_VERSION }} - Super App Upgrade"
          body: |
            ## ğŸš€ v1.1.5 é‡Œç¨‹ç¢‘æ›´æ–°

            ### ğŸŒŸ æ ¸å¿ƒåŠŸèƒ½å‡çº§
            - **DeepGlow Studio é›†æˆ**: æ–°å¢ WebGL å›¾åƒå¤„ç†å·¥å…·ï¼Œæ”¯æŒè¾‰å…‰ã€è‰²æ¸©è°ƒèŠ‚ï¼Œå¹¶å¯ä¿å­˜è‡³ç›¸å†Œã€‚
            - **å…¨æ–°æ¶æ„**: é‡‡ç”¨ Bottom Tab + Stack æ··åˆå¯¼èˆªï¼Œæ“ä½œæ›´æµç•…ã€‚
            - **è‡ªå®šä¹‰é¦–é¡µ**: æ”¯æŒæ›´æ¢é¦–é¡µå£çº¸ï¼Œé›†æˆå¤©æ°”ä¸æ¯æ—¥è¯­å½•ç»„ä»¶ã€‚

            ### ğŸ¨ UI/UX äº¤äº’ç„•æ–°
            - **æ‚¬æµ® Tab æ **: å…¨æ–°è®¾è®¡çš„æ¤­åœ†æ‚¬æµ®åº•éƒ¨å¯¼èˆªï¼Œå¸¦æœ‰å¹³æ»‘çš„èƒŒæ™¯è·ŸéšåŠ¨ç”»ã€‚
            - **åˆ—è¡¨ä¼˜åŒ–**: VibeWall åˆ—è¡¨é‡‡ç”¨åŠ¨æ€é«˜åº¦ç€‘å¸ƒæµï¼Œå¹¶å¢åŠ æ¨ª/ç«–å±è§’æ ‡æç¤ºã€‚
            - **æ²‰æµ¸å¼ä½“éªŒ**: ä¼˜åŒ–å…¨å±æµè§ˆå’Œä¸‹è½½é¡µé¢çš„è§†è§‰åé¦ˆã€‚

            ### ğŸ“¥ ä¸‹è½½ä¸­å¿ƒ 2.0
            - **æ™ºèƒ½ç®¡ç†**: æ”¯æŒä»»åŠ¡æ’é˜Ÿã€å»é‡ã€å¤±è´¥é‡è¯•ã€‚
            - **æ•°æ®å¯è§†åŒ–**: æ˜¾ç¤ºå…·ä½“çš„ä¸‹è½½è¿›åº¦ (MB) å’ŒçŠ¶æ€ã€‚
            - **æƒé™ä¿®å¤**: å®Œç¾é€‚é… Android 13+ åª’ä½“æƒé™ã€‚

            ---
            *Built with â¤ï¸ by GitHub Actions*
          artifacts: "./forme.apk"
          token: ${{ secrets.GITHUB_TOKEN }}
          allowUpdates: true