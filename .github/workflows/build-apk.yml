name: Build Android APK & Release

permissions:
  contents: write

on:
  workflow_dispatch:

jobs:
  build:
    name: ğŸ— Build & Release
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¦ Check out Git repository
        uses: actions/checkout@v4

      # --- æ–°å¢æ­¥éª¤ï¼šæå–ç‰ˆæœ¬å· ---
      # jq æ˜¯ä¸€ä¸ªå¤„ç† JSON çš„å·¥å…·ï¼ŒGitHub æœåŠ¡å™¨è‡ªå¸¦
      - name: ğŸ“– Get Version from app.json
        id: get_version
        run: |
          echo "APP_VERSION=$(jq -r .expo.version app.json)" >> $GITHUB_OUTPUT
          echo "æ£€æµ‹åˆ°ç‰ˆæœ¬å·: $(jq -r .expo.version app.json)"

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18.x
          cache: npm

      - name: âš™ï¸ Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: ğŸ“¦ Install dependencies
        run: npm install

      - name: ğŸš€ Build APK (Local)
        # è¾“å‡ºæ–‡ä»¶åä¹Ÿå¸¦ä¸Šç‰ˆæœ¬å·ï¼Œæ–¹ä¾¿åŒºåˆ†
        run: eas build --platform android --profile preview --non-interactive --local --output=./forme-v${{ steps.get_version.outputs.APP_VERSION }}.apk

      - name: ğŸ‰ Create Release
        uses: ncipollo/release-action@v1
        with:
          # ä½¿ç”¨ä» app.json è¯»å‡ºæ¥çš„ç‰ˆæœ¬å·
          tag: "v${{ steps.get_version.outputs.APP_VERSION }}"
          name: "v${{ steps.get_version.outputs.APP_VERSION }} - Major Update"
          body: |
            ## æ›´æ–°æ—¥å¿—
            - ğŸ‰ å…¨æ–° UI è®¾è®¡
            - ğŸ“¥ æ–°å¢ä¸‹è½½ç®¡ç†å™¨ (å®æ—¶è¿›åº¦æ˜¾ç¤º)
            - ğŸ–¼ï¸ ä¿®å¤ Android æƒé™é—®é¢˜
            - ğŸ“± æ›´æ¢äº† App å›¾æ ‡
          artifacts: "./forme-v${{ steps.get_version.outputs.APP_VERSION }}.apk"
          token: ${{ secrets.GITHUB_TOKEN }}
          # å…è®¸æ›´æ–°åŒä¸€ä¸ª Release (é˜²æ­¢ä½ æ”¹äº†ä»£ç å¿˜äº†æ”¹ç‰ˆæœ¬å·æŠ¥é”™)
          allowUpdates: true