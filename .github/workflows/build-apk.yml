name: Build Android APK & Release
permissions:
  contents: write
on:
  workflow_dispatch:

jobs:
  build:
    name: ğŸ— Build & Release
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¦ Check out Git repository
        uses: actions/checkout@v4

      # ğŸ”¥ æ ¸å¿ƒï¼šå¢åŠ  Swap ç©ºé—´ï¼Œé˜²æ­¢ OOM çˆ†å†…å­˜
      - name: ğŸ’¾ Increase Swap Space
        run: |
          sudo swapoff -a
          sudo fallocate -l 10G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          sudo swapon --show

      - name: ğŸ“– Get Version
        id: get_version
        run: |
          echo "APP_VERSION=$(jq -r .expo.version app.config.js || jq -r .expo.version app.json)" >> $GITHUB_OUTPUT

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18.x
          cache: npm

      - name: âš™ï¸ Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: ğŸ“¦ Install dependencies
        run: npm install

      # å»ºè®®åŠ ä¸Š --clear-cache ç¡®ä¿ Gradle é…ç½®ç”Ÿæ•ˆ
      - name: ğŸš€ Build APK (Local)
        run: eas build --platform android --profile preview --non-interactive --local --clear-cache --output=./forme.apk

      - name: ğŸ‰ Create Release
        uses: ncipollo/release-action@v1
        with:
          tag: "v${{ steps.get_version.outputs.APP_VERSION }}"
          name: "v${{ steps.get_version.outputs.APP_VERSION }} Release"
          body: "GitHub Actions è‡ªåŠ¨æ„å»ºç‰ˆæœ¬ï¼ŒåŒ…å« expo-updates æ”¯æŒã€‚"
          artifacts: "./forme.apk"
          token: ${{ secrets.GITHUB_TOKEN }}
          allowUpdates: true