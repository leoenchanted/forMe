name: Build Android APK & Release

permissions:
  contents: write

on:
  workflow_dispatch:

jobs:
  build:
    name: ğŸ— Build & Release
    runs-on: macos-latest
    steps:
      - name: ğŸ“¦ Check out Git repository
        uses: actions/checkout@v4

      - name: ğŸ“– Get Version from app.config.js
        id: get_version
        # è¿™é‡Œç”¨ grep æå– versionï¼Œå› ä¸º app.config.js æ˜¯ JS æ–‡ä»¶ä¸æ˜¯ JSON
        # è¿™ç§å†™æ³•æ¯”è¾ƒç²—æš´ä½†æœ‰æ•ˆï¼šæå– version: "x.x.x" ä¸­çš„ x.x.x
        run: |
          VER=$(grep -o 'version: "[^"]*"' app.config.js | cut -d'"' -f2)
          echo "APP_VERSION=$VER" >> $GITHUB_OUTPUT
          echo "Detected Version: $VER"

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18.x
          cache: npm

      - name: âš™ï¸ Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: ğŸ“¦ Install dependencies
        run: npm install

      - name: ğŸš€ Build APK (Local)
        # --profile preview å¯¹åº”æ­£å¼ç‰ˆé…ç½®
        run: eas build --platform android --profile preview --non-interactive --local --output=./forme-v${{ steps.get_version.outputs.APP_VERSION }}.apk

      - name: ğŸ‰ Create Release
        uses: ncipollo/release-action@v1
        with:
          tag: "v${{ steps.get_version.outputs.APP_VERSION }}"
          name: "v${{ steps.get_version.outputs.APP_VERSION }} - OTA Enabled & Icon Fix"
          body: |
            ## ğŸš€ v1.1.2 æ›´æ–°æ—¥å¿— (é‡Œç¨‹ç¢‘ç‰ˆæœ¬)

            ### âœ¨ é‡å¤§æ›´æ–°
            - **ğŸ”¥ çƒ­æ›´æ–° (OTA) æ”¯æŒ**ï¼šå·²æ³¨å…¥æ›´æ–°é…ç½®ï¼Œæœªæ¥å°ä¿®å°è¡¥æ— éœ€é‡è£… Appã€‚
            - **ğŸ¨ å›¾æ ‡ä¿®å¤**ï¼šä¿®å¤äº†æ­£å¼ç‰ˆæ¡Œé¢å›¾æ ‡æ˜¾ç¤ºä¸º Expo é»˜è®¤ Logo çš„é—®é¢˜ã€‚
            - **ğŸ›¡ï¸ æƒé™ä¼˜åŒ–**ï¼šApp å¯åŠ¨æ—¶è‡ªåŠ¨æ£€æŸ¥ç›¸å†Œæƒé™ï¼Œè¢«æ‹’åå¼•å¯¼è‡³è®¾ç½®é¡µï¼Œè§£å†³æ— æ³•ä¸‹è½½çš„é—®é¢˜ã€‚

            ### ğŸ“± åŠŸèƒ½å®Œå–„
            - æµè§ˆé‡ (Views) æ•°æ®ç°åœ¨å¯ä»¥æ­£ç¡®åŠ è½½ã€‚
            - ä¸‹è½½ä»»åŠ¡æ”¯æŒé˜²é‡å¤ç‚¹å‡»ã€‚
            - æœç´¢åˆ—è¡¨å¸ƒå±€ä¼˜åŒ–ã€‚

            ---
            *æ­¤ç‰ˆæœ¬ä¸ºâ€œåŸºå‡†åŒ…â€ï¼Œå»ºè®®æ‰€æœ‰ç”¨æˆ·æ›´æ–°ã€‚*
          artifacts: "./forme-v${{ steps.get_version.outputs.APP_VERSION }}.apk"
          token: ${{ secrets.GITHUB_TOKEN }}
          allowUpdates: true
