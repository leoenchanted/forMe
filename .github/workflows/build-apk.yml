name: Build Android APK & Release

permissions:
  contents: write

on:
  workflow_dispatch:

jobs:
  build:
    name: ğŸ— Build & Release
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¦ Check out Git repository
        uses: actions/checkout@v4

      - name: ğŸ“– Get Version from app.json
        id: get_version
        run: |
          echo "APP_VERSION=$(jq -r .expo.version app.json)" >> $GITHUB_OUTPUT
          echo "æ£€æµ‹åˆ°ç‰ˆæœ¬å·: $(jq -r .expo.version app.json)"

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18.x
          cache: npm

      - name: âš™ï¸ Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: ğŸ“¦ Install dependencies
        run: npm install

      - name: ğŸš€ Build APK (Local)
        # è¾“å‡ºæ–‡ä»¶åå¸¦ä¸Šç‰ˆæœ¬å·
        run: eas build --platform android --profile preview --non-interactive --local --output=./forme-v${{ steps.get_version.outputs.APP_VERSION }}.apk

      # --- æ ¸å¿ƒä¿®æ”¹ï¼šæ›´æ–°æ—¥å¿—æ–‡æ¡ˆ ---
      - name: ğŸ‰ Create Release
        uses: ncipollo/release-action@v1
        with:
          tag: "v${{ steps.get_version.outputs.APP_VERSION }}"
          name: "v${{ steps.get_version.outputs.APP_VERSION }} - Download Manager & UI Polish"
          body: |
            ## ğŸš€ v1.1.1 æ›´æ–°æ—¥å¿—

            ### ğŸ“¥ ä¸‹è½½ä¸­å¿ƒå¤§å‡çº§ (Download Manager)
            - **å®æ—¶æ•°æ®**ï¼šæ–°å¢ä¸‹è½½è¿›åº¦æ˜¾ç¤º (ä¾‹å¦‚: `2.5MB / 5.0MB`)ã€‚
            - **ä»»åŠ¡ç®¡ç†**ï¼šæ”¯æŒ **æš‚åœ/åœæ­¢** ä¸‹è½½ä»»åŠ¡ã€‚
            - **åå°ä¸‹è½½**ï¼šé€€å‡ºè¯¦æƒ…é¡µåä¸‹è½½ä»»åŠ¡ä»åœ¨åå°ç»§ç»­ã€‚
            - **æ™ºèƒ½é€»è¾‘**ï¼šä¼˜åŒ–ä»»åŠ¡å»é‡ä¸å¤±è´¥é‡è¯•æœºåˆ¶ã€‚

            ### ğŸ¨ UI/UX ä½“éªŒä¼˜åŒ–
            - **æ²‰æµ¸å¼äº¤äº’**ï¼šç§»é™¤åŸç”Ÿ Alertï¼Œå…¨é¢å¯ç”¨è‡ªå®šä¹‰ **é»‘è‰²èƒ¶å›Šå¼¹çª— (Toast)**ã€‚
            - **å…¨æ–°èœå•**ï¼šå³ä¸Šè§’æ–°å¢æ‚¬æµ®èœå• (Favorites / Downloads / Settings)ã€‚
            - **åˆ—è¡¨å‡çº§**ï¼šæœç´¢ç»“æœé‡‡ç”¨ **åŠ¨æ€é«˜åº¦å¸ƒå±€**ï¼Œå¹¶å¢åŠ  **æ¨ªç«–å±è§’æ ‡** æç¤ºã€‚
            - **ç»†èŠ‚æ‰“ç£¨**ï¼šä¿®å¤æ¯æ—¥æ¨èç‚¹å‡»æ—¶çš„ç™½è‰²èƒŒæ™¯é—ªçƒé—®é¢˜ï¼›è¯¦æƒ…é¡µæ–°å¢â€œå¤åˆ¶åŸå›¾é“¾æ¥â€æŒ‰é’®ã€‚

            ### ğŸ› æ ¸å¿ƒä¿®å¤ (Bug Fixes)
            - ä¿®å¤ Android 13+ ä¿å­˜ç›¸å†Œæƒé™å¯¼è‡´å´©æºƒçš„é—®é¢˜ã€‚
            - ä¿®å¤ `String cannot be cast to Boolean` å¯¼è‡´çš„å¯åŠ¨å´©æºƒã€‚
            - ä¿®å¤ App å›¾æ ‡åœ¨éƒ¨åˆ†æœºå‹æ˜¾ç¤ºä¸ºé»˜è®¤ Expo Logo çš„é—®é¢˜ã€‚
            - ä¿®å¤è¯¦æƒ…é¡µæµè§ˆé‡ (Views) æ•°æ®ä¸æ˜¾ç¤ºçš„é—®é¢˜ã€‚
            
            ---
            *Built with â¤ï¸ by Expo & GitHub Actions*
          artifacts: "./forme-v${{ steps.get_version.outputs.APP_VERSION }}.apk"
          token: ${{ secrets.GITHUB_TOKEN }}
          allowUpdates: true