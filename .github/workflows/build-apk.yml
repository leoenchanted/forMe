name: Build Android APK & Release
on:
  workflow_dispatch:
permissions:
  contents: write
jobs:
  build:
    name: ğŸ— Build & Release
    runs-on: ubuntu-latest
    env:
      APP_VARIANT: preview
    steps:
      - name: ğŸ“¦ Check out Git repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          ref: main # æ–°å¢ï¼šå›ºå®šä½¿ç”¨ main åˆ†æ”¯ï¼ˆæ­£å¼APKä¸“ç”¨ï¼‰
      # ğŸ”¥ æ ¸å¿ƒï¼šå¢åŠ  Swap ç©ºé—´ï¼Œé˜²æ­¢ OOM çˆ†å†…å­˜
      - name: ğŸ’¾ Increase Swap Space
        run: |
          sudo apt clean
          sudo apt autoremove -y
          sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/share/boost
          sudo rm -rf /usr/local/lib/android/sdk/{system-images,emulator,sources,docs}
          if [ -d "/usr/local/lib/android/sdk/platforms/android-34" ]; then
            sudo mv /usr/local/lib/android/sdk/platforms/android-34 /tmp/
            sudo rm -rf /usr/local/lib/android/sdk/platforms/*
            sudo mv /tmp/android-34 /usr/local/lib/android/sdk/platforms/
          fi
      # ğŸ’¾ åˆ›å»º 3GB Swap
      - name: ğŸ’¾ Create 3GB Swap (Balance RAM vs Disk)
        run: |
          echo "Current free space:"
          df -h
          sudo fallocate -l 3G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          echo "Swap enabled:"
          sudo swapon --show
      # è¯»å– app.config.js ç‰ˆæœ¬å·
      - name: ğŸ“– Get Version
        id: get_version
        run: |
          VER=$(grep -o 'version: "[^"]*"' app.config.js | cut -d'"' -f2)
          echo "APP_VERSION=$VER" >> $GITHUB_OUTPUT
          echo "Detected Version: $VER"
      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18.x
          cache: npm
      - name: âš™ï¸ Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}
      - name: ğŸ“¦ Install dependencies
        run: npm install
      # æ„å»ºæ­£å¼APK
      - name: ğŸš€ Build APK (Local)
        run: eas build --platform android --profile preview --non-interactive --local --clear-cache --output=./formev${{ steps.get_version.outputs.APP_VERSION }}.apk
      # ğŸ§¹ æ„å»ºåæ¸…ç†
      - name: ğŸ§¹ Post-build cleanup
        if: always()
        run: |
          sudo swapoff /swapfile || true
          sudo rm -f /swapfile || true
          rm -rf ~/.gradle/caches ~/.gradle/wrapper
          rm -rf $HOME/.npm/_cacache
          echo "Final disk usage:"
          df -h
      # åˆ›å»º Release
      - name: ğŸ‰ Create Release
        uses: ncipollo/release-action@v1
        with:
          tag: "v${{ steps.get_version.outputs.APP_VERSION }}"
          name: "v${{ steps.get_version.outputs.APP_VERSION }} - Super App Upgradev1.1.7"
          body: |
            ## ğŸš€ v1.1.7 é‡å¤§æ›´æ–°
            ### ğŸ› ï¸ å…¨æ–°å·¥å…·ç®± (Tools Tab)
            - **æ–°å¢å·¥å…·é¡µé¢**: åº•éƒ¨å¯¼èˆªæ æ–°å¢ Tools å…¥å£ï¼Œæœªæ¥å°†é›†æˆæ›´å¤šå®ç”¨å·¥å…·ã€‚
            - **é€šç”¨å·¥å…·å¼•æ“**: å¼•å…¥ `UniversalTool` æ¶æ„ï¼Œæ”¯æŒè½»é‡çº§ Web å·¥å…·å³æ’å³ç”¨ã€‚
            - **æ–°å¢å·¥å…·**: HSL è°ƒè‰²æ¿ (HSL Color Mixer)ï¼Œæ”¯æŒå®æ—¶é¢„è§ˆä¸å¤åˆ¶ã€‚
            ### âš¡ äº¤äº’ä¸èƒ½åŠ›å‡çº§
            - **è§¦è§‰åé¦ˆ**: å¼•å…¥ `expo-haptics`ï¼Œä¸ºå·¥å…·å’Œæ“ä½œæä¾›ç»†è…»çš„éœ‡åŠ¨åé¦ˆã€‚
            - **å‰ªåˆ‡æ¿æ”¯æŒ**: å·¥å…·å†…æ”¯æŒä¸€é”®å¤åˆ¶å†…å®¹ã€‚
            - **æ›´æ–°æœºåˆ¶ä¿®å¤**: ä¿®å¤äº†åº”ç”¨å†…æ›´æ–°æ— æ³•ä¸‹è½½çš„é—®é¢˜ï¼Œæ”¹ç”¨æµè§ˆå™¨é«˜é€Ÿä¸‹è½½é€šé“ (ghproxy)ã€‚
            ### ğŸ› ä¼˜åŒ–ä¸ä¿®å¤
            - ä¿®å¤äº†å›¾æ ‡åœ¨éƒ¨åˆ†æœºå‹æ˜¾ç¤ºå¼‚å¸¸çš„é—®é¢˜ (Adaptive Icon)ã€‚
            - ä¼˜åŒ–äº†åº•å±‚ä¾èµ–ç»“æ„ã€‚
            ---
            *Built with â¤ï¸ by GitHub Actions*
          artifacts: "./formev${{ steps.get_version.outputs.APP_VERSION }}.apk"
          token: ${{ secrets.GITHUB_TOKEN }}
          allowUpdates: true