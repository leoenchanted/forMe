name: Build Android APK & Release
on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    name: ğŸ— Build & Release
    runs-on: ubuntu-latest
    env:
      APP_VARIANT: preview

    steps:
      - name: ğŸ“¦ Check out Git repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # ğŸ”¥ å…³é”®ï¼šå…ˆæ¸…ç†ç£ç›˜ï¼Œå†åˆ›å»ºå°å®¹é‡ swap
      - name: ğŸ§¹ Free up disk space FIRST
        run: |
          # æ¸…ç†ç³»ç»Ÿåƒåœ¾
          sudo apt clean
          sudo apt autoremove -y
          sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/share/boost
          
          # ç²¾ç®€ Android SDKï¼ˆåªä¿ç•™å¿…è¦ç»„ä»¶ï¼‰
          sudo rm -rf /usr/local/lib/android/sdk/{system-images,emulator,sources,docs}
          
          # åªä¿ç•™ä¸€ä¸ª platformï¼ˆå¦‚ android-34ï¼‰
          if [ -d "/usr/local/lib/android/sdk/platforms/android-34" ]; then
            sudo mv /usr/local/lib/android/sdk/platforms/android-34 /tmp/
            sudo rm -rf /usr/local/lib/android/sdk/platforms/*
            sudo mv /tmp/android-34 /usr/local/lib/android/sdk/platforms/
          fi

      # ğŸ’¾ åˆ›å»º 3GB Swapï¼ˆè¶³å¤Ÿé˜² OOMï¼Œåˆä¸è‡³äºåƒå…‰ç£ç›˜ï¼‰
      - name: ğŸ’¾ Create 3GB Swap (Balance RAM vs Disk)
        run: |
          echo "Current free space:"
          df -h
          sudo fallocate -l 3G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          echo "Swap enabled:"
          sudo swapon --show

      - name: ğŸ“– Get Version
        id: get_version
        run: |
          echo "APP_VERSION=$(jq -r '.expo.version // empty' app.config.js)" >> $GITHUB_OUTPUT

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18.x
          cache: npm

      - name: âš™ï¸ Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: ğŸ“¦ Install dependencies
        run: npm install

      # âœ… æœ¬åœ°æ„å»ºï¼ˆä½ çš„æ ¸å¿ƒéœ€æ±‚ï¼šé¿å… EAS æ’é˜Ÿï¼‰
      - name: ğŸš€ Build APK (Local)
        run: eas build --platform android --profile preview --non-interactive --local --clear-cache --output=./forme.apk

      # ğŸ§¹ æ„å»ºåç«‹å³é‡Šæ”¾æ‰€æœ‰ç¼“å­˜ï¼ˆåŒ…æ‹¬ swap æ–‡ä»¶ï¼ï¼‰
      - name: ğŸ§¹ Post-build cleanup
        if: always()
        run: |
          # åˆ é™¤ swap æ–‡ä»¶ï¼Œå›æ”¶ç£ç›˜
          sudo swapoff /swapfile || true
          sudo rm -f /swapfile || true
          
          # æ¸…ç†æ„å»ºç¼“å­˜
          rm -rf ~/.gradle/caches ~/.gradle/wrapper
          rm -rf $HOME/.npm/_cacache
          
          echo "Final disk usage:"
          df -h

      - name: ğŸ‰ Create Release
        uses: ncipollo/release-action@v1
        with:
          tag: "v${{ steps.get_version.outputs.APP_VERSION }}"
          name: "v${{ steps.get_version.outputs.APP_VERSION }} Release"
          body: "GitHub Actions æœ¬åœ°æ„å»ºç‰ˆæœ¬ï¼Œæ”¯æŒ expo-updatesã€‚"
          artifacts: "./forme.apk"
          token: ${{ secrets.GITHUB_TOKEN }}
          allowUpdates: true
